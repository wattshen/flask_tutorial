{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}Posts{% endblock %}</h1>
  <div style="flex-grow: 1; margin: 0 1rem;">
    <form action="{{ url_for('blog.index') }}" method="get" style="display: flex; gap: 0.5rem;">
      <input type="text" name="q" placeholder="Search titles..." value="{{ search_query or '' }}">
      <button type="submit">Search</button>
      {% if current_tag or search_query %}
        <a href="{{ url_for('blog.index') }}" style="align-self: center;">Clear</a>
      {% endif %}
    </form>
  </div>
  {% if g.user %}
    <a class="action" href="{{ url_for('blog.create') }}">New</a>
  {% endif %}
{% endblock %}

{% block content %}
  {% for post in posts %}
    <article class="post">
      <header>
        <div>
          <h1><a href={{ url_for('blog.detail',id=post['id']) }}>{{ post['title'] }}</a></h1>
          <div class="about">by {{ post['username'] }} on {{ post['created'] | local_time }}</div>
          {% if post['tags'] %}
            <div class="tags" style="font-size: 0.8em; margin-top: 0.2rem;">
              Tags: 
              {% for tag in post['tags'].split(',') %}
                <a href="{{ url_for('blog.index', tag=tag) }}" style="color: #777; text-decoration: none; background: #eee; padding: 0.1rem 0.3rem; border-radius: 3px;">{{ tag }}</a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
        {% if g.user['id'] == post['author_id'] %}
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <a class="action" href="{{ url_for('blog.update', id=post['id']) }}">Edit</a>
            <form action="{{ url_for('blog.delete', id=post['id']) }}" method="post" style="display: inline;">
              <button class="action" type="submit" onclick="return confirm('确定要删除吗？');" style="border:none; background:none; cursor:pointer; color:#377ba8; padding:0.5rem; font:inherit;">Delete</button>
            </form>
          </div>
        {% endif %}
      </header>
      <p class="body">{{ post['body'] | truncate(200)}}</p>
    </article>
    {% if not loop.last %}
      <hr>
    {% endif %}
  {% endfor %}
  <div class="pagination" style="margin-top: 20px; text-align: center;">
    {% if page > 1 %}
      <a href="{{ url_for('blog.index', page=page-1, q=search_query, tag=current_tag) }}">Previous</a>
    {% endif %}
    
    <span style="margin: 0 10px;">Page {{ page }} of {{ total_pages }}</span>
  
    {% if page < total_pages %}
      <a href="{{ url_for('blog.index', page=page+1, q=search_query, tag=current_tag) }}">Next</a>
    {% endif %}
  </div>
{% endblock %}
